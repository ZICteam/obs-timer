name: Build OBS Timer Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  windows:
    name: Windows Build
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Clone OBS Studio (headers only)
      shell: pwsh
      run: |
        Write-Host "Cloning OBS Studio..."
        git clone --depth 1 --branch 30.2.2 https://github.com/obsproject/obs-studio.git obs-studio
        
    - name: Download OBS Windows Dependencies
      shell: pwsh
      run: |
        Write-Host "Downloading OBS Windows dependencies..."
        $url = "https://github.com/obsproject/obs-deps/releases/download/2023-04-12/windows-deps-2023-04-12-x64.zip"
        Invoke-WebRequest -Uri $url -OutFile "obs-deps.zip"
        Expand-Archive -Path "obs-deps.zip" -DestinationPath "obs-deps"
    
    - name: Build minimal libobs (only library, no UI/plugins)
      shell: pwsh
      run: |
        Write-Host "Building minimal libobs for plugin linking..."
        cd obs-studio
        cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$PWD\..\obs-deps" `
          -DENABLE_PLUGINS=OFF `
          -DENABLE_UI=OFF `
          -DENABLE_SCRIPTING=OFF `
          -DENABLE_BROWSER=OFF `
          -DENABLE_WEBSOCKET=OFF `
          -DBUILD_FOR_DISTRIBUTION=OFF
        cmake --build build --config Release --target obs
        Write-Host "libobs built successfully!"
        
    - name: Configure Plugin
      shell: pwsh
      run: |
        Write-Host "Configuring timer plugin..."
        cmake -S . -B build_plugin `
          -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$PWD\obs-deps" `
          -DOBS_INCLUDE_DIR="$PWD\obs-studio\libobs" `
          -DOBS_LIB_DIR="$PWD\obs-studio\build\libobs\Release"
    
    - name: Build Plugin
      shell: pwsh
      run: |
        Write-Host "Building timer plugin..."
        cmake --build build_plugin --config Release
        Write-Host "Plugin built: obs-timer-plugin.dll"
    
    - name: Package
      shell: pwsh
      run: |
        Write-Host "Packaging plugin..."
        New-Item -ItemType Directory -Force -Path "release\obs-plugins\64bit"
        New-Item -ItemType Directory -Force -Path "release\data\obs-plugins\obs-timer-plugin\locale"
        
        # –ö–æ–ø–∏—Ä—É–µ–º DLL –ø–ª–∞–≥–∏–Ω–∞
        Copy-Item "build_plugin\Release\obs-timer-plugin.dll" -Destination "release\obs-plugins\64bit\"
        
        # –ö–æ–ø–∏—Ä—É–µ–º –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—é
        Copy-Item "data\locale\*.ini" -Destination "release\data\obs-plugins\obs-timer-plugin\locale\"
        
        # –°–æ–∑–¥–∞—ë–º README –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        @"
# OBS Timer Plugin - Installation

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–∞:

1. –ó–∞–∫—Ä–æ–π—Ç–µ OBS Studio
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã:
   - obs-plugins\64bit\obs-timer-plugin.dll ‚Üí C:\Program Files\obs-studio\obs-plugins\64bit\
   - data\obs-plugins\obs-timer-plugin\ ‚Üí C:\Program Files\obs-studio\data\obs-plugins\

3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ OBS Studio
4. –ò—Å—Ç–æ—á–Ω–∏–∫–∏ ‚Üí ‚ûï ‚Üí "Countdown Timer"

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

- –î–æ–±–∞–≤—å—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫ "Countdown Timer" –≤ —Å—Ü–µ–Ω—É
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ "–°–≤–æ–π—Å—Ç–≤–∞"
- –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç–∞–π–º–µ—Ä–æ–º —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏ Start/Stop/Reset

–ì–æ—Ç–æ–≤–æ! üéâ
"@ | Out-File -FilePath "release\INSTALL.txt" -Encoding UTF8
        
        Compress-Archive -Path "release\*" -DestinationPath "obs-timer-plugin-windows.zip" -Force
        Write-Host "Package created: obs-timer-plugin-windows.zip"
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: obs-timer-plugin-windows
        path: obs-timer-plugin-windows.zip
  
  linux:
    name: Linux Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install Dependencies  
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libobs-dev obs-studio
    
    - name: Configure
      run: |
        mkdir build
        cd build
        cmake ..
    
    - name: Build
      run: |
        cd build
        make -j$(nproc)
    
    - name: Package
      run: |
        mkdir release
        cp build/obs-timer-plugin.so release/
        cp -r data release/
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: obs-timer-plugin-linux
        path: release/*
