name: Build OBS Timer Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  windows:
    name: Windows Build
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Clone OBS Studio
      shell: pwsh
      run: |
        Write-Host "Cloning OBS Studio..."
        git clone --recursive --depth 1 --branch 30.2.2 https://github.com/obsproject/obs-studio.git
        
    - name: Download OBS Dependencies
      shell: pwsh
      run: |
        Write-Host "Downloading OBS dependencies..."
        cd obs-studio
        $url = "https://cdn-fastly.obsproject.com/downloads/dependencies2023.tar.xz"
        Invoke-WebRequest -Uri $url -OutFile "dependencies.tar.xz"
        tar -xf dependencies.tar.xz
    
    - name: Build OBS libobs
      shell: pwsh
      run: |
        Write-Host "Building OBS libobs..."
        cd obs-studio
        cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DENABLE_BROWSER=OFF `
          -DENABLE_WEBSOCKET=OFF `
          -DENABLE_UI=OFF `
          -DBUILD_TESTS=OFF
        cmake --build build --config Release --target libobs
    
    - name: Configure Plugin
      shell: pwsh
      run: |
        $env:OBS_SOURCE_DIR = "$PWD\obs-studio"
        cmake -S . -B build_plugin `
          -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DOBS_INCLUDE_DIR="$PWD\obs-studio\libobs" `
          -DOBS_LIB_DIR="$PWD\obs-studio\build\libobs\Release"
    
    - name: Build Plugin
      run: cmake --build build_plugin --config Release
    
    - name: Package
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "release\obs-plugins\64bit"
        New-Item -ItemType Directory -Force -Path "release\data\obs-plugins\obs-timer-plugin\locale"
        
        Copy-Item "build_plugin\Release\obs-timer-plugin.dll" -Destination "release\obs-plugins\64bit\" -ErrorAction SilentlyContinue
        Copy-Item "data\locale\*.ini" -Destination "release\data\obs-plugins\obs-timer-plugin\locale\" -Recurse
        
        Compress-Archive -Path "release\*" -DestinationPath "obs-timer-plugin-windows.zip"
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: obs-timer-plugin-windows
        path: obs-timer-plugin-windows.zip
  
  linux:
    name: Linux Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install Dependencies  
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libobs-dev obs-studio
    
    - name: Configure
      run: |
        mkdir build
        cd build
        cmake ..
    
    - name: Build
      run: |
        cd build
        make -j$(nproc)
    
    - name: Package
      run: |
        mkdir release
        cp build/obs-timer-plugin.so release/
        cp -r data release/
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: obs-timer-plugin-linux
        path: release/*
