name: Build OBS Timer Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  windows:
    name: Windows Build
    runs-on: windows-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2
    
    - name: Download OBS Studio
      shell: pwsh
      run: |
        Write-Host "Downloading OBS Studio..."
        $obsVersion = "30.2.2"
        $url = "https://github.com/obsproject/obs-studio/releases/download/$obsVersion/OBS-Studio-$obsVersion-Windows.zip"
        Invoke-WebRequest -Uri $url -OutFile "obs-studio.zip"
        Expand-Archive -Path "obs-studio.zip" -DestinationPath "obs-studio"
        
    - name: Download OBS Dependencies
      shell: pwsh
      run: |
        Write-Host "Downloading OBS dependencies..."
        $url = "https://github.com/obsproject/obs-deps/releases/download/2023-11-03/windows-deps-2023-11-03-x64.zip"
        Invoke-WebRequest -Uri $url -OutFile "obs-deps.zip"
        Expand-Archive -Path "obs-deps.zip" -DestinationPath "obs-deps"
    
    - name: Configure
      shell: pwsh
      run: |
        $env:OBS_PLUGIN_DESTINATION = "$PWD\build\Release"
        cmake -S . -B build `
          -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_PREFIX_PATH="$PWD\obs-studio;$PWD\obs-deps" `
          -DOBS_INCLUDE_DIR="$PWD\obs-studio\include" `
          -DOBS_LIB_DIR="$PWD\obs-studio\bin\64bit"
    
    - name: Build
      run: cmake --build build --config Release
    
    - name: Package
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path "release\obs-plugins\64bit"
        New-Item -ItemType Directory -Force -Path "release\data\obs-plugins\obs-timer-plugin\locale"
        
        Copy-Item "build\Release\obs-timer-plugin.dll" -Destination "release\obs-plugins\64bit\" -ErrorAction SilentlyContinue
        Copy-Item "build\obs-timer-plugin.dll" -Destination "release\obs-plugins\64bit\" -ErrorAction SilentlyContinue
        Copy-Item "data\locale\*.ini" -Destination "release\data\obs-plugins\obs-timer-plugin\locale\" -Recurse
        
        Compress-Archive -Path "release\*" -DestinationPath "obs-timer-plugin-windows.zip"
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: obs-timer-plugin-windows
        path: obs-timer-plugin-windows.zip
  
  linux:
    name: Linux Build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install Dependencies  
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libobs-dev obs-studio
    
    - name: Configure
      run: |
        mkdir build
        cd build
        cmake ..
    
    - name: Build
      run: |
        cd build
        make -j$(nproc)
    
    - name: Package
      run: |
        mkdir release
        cp build/obs-timer-plugin.so release/
        cp -r data release/
    
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: obs-timer-plugin-linux
        path: release/*
